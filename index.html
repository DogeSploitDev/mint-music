<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mint Music Player</title>
  <style>
    :root {
      --mint-700: #0fb88f;
      --mint-600: #17c9a0;
      --mint-500: #25dbb1;
      --mint-200: #c9f6ea;
      --ink-900: #0b1020;
      --ink-700: #1b2236;
      --ink-500: #2a3550;
      --ink-300: #5c6a8a;
      --white: #ffffff;
      --glass: rgba(255,255,255,0.08);
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      color-scheme: dark light;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, var(--ink-900), var(--ink-700));
      color: var(--white);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 2rem;
    }
    .app {
      width: 100%;
      max-width: 860px;
    }
    header {
      display: flex; align-items: center; justify-content: space-between; gap: 1rem; margin-bottom: 1rem;
    }
    .brand {
      display: flex; align-items: center; gap: .75rem;
    }
    .logo {
      width: 42px; height: 42px; border-radius: 12px;
      background: linear-gradient(135deg, var(--mint-700), var(--mint-500));
      box-shadow: var(--shadow);
    }
    h1 { font-size: 1.25rem; margin: 0; font-weight: 700; letter-spacing: .2px; }
    .auth { display: flex; align-items: center; gap: .5rem; }
    .pill { padding: .25rem .5rem; border-radius: 999px; background: var(--glass); font-size: .85rem; color:#d7e2ff; }
    button {
      background: var(--mint-600); color: #06221b; font-weight: 700;
      border: 0; border-radius: 10px; padding: .7rem 1rem; cursor: pointer;
      transition: transform .05s ease, filter .1s ease; box-shadow: var(--shadow);
    }
    button:hover { filter: brightness(1.05); }
    button:active { transform: translateY(1px); }
    button.secondary { background: var(--ink-500); color: #e6fdf7; box-shadow: none; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 20px; padding: 1.25rem; box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }
    .grid { display: grid; grid-template-columns: 1.2fr .8fr; gap: 1rem; }
    @media (max-width: 820px) { .grid { grid-template-columns: 1fr; } }
    label { display: block; margin-bottom: .5rem; color: #d9fff5; }
    input[type="url"] {
      width: 100%; padding: .9rem 1rem; border-radius: 12px; border: 1px solid rgba(255,255,255,.2);
      background: rgba(0,0,0,.2); color: #eafff8; font-size: 1rem; outline: none;
    }
    .row { display:flex; gap:.6rem; flex-wrap: wrap; margin-top: .75rem; }
    .hint { color: #bfeee2; font-size: .9rem; margin-top: .5rem; }
    .ok { color: #89f5d9; }
    .err { color: #ffb2b2; }
    .player {
      display: grid; grid-template-columns: 120px 1fr; gap: 1rem; align-items: center;
    }
    .cover {
      width: 120px; height: 120px; border-radius: 16px; background: #0d1425; border: 1px solid rgba(255,255,255,.15);
      background-size: cover; background-position: center;
    }
    .meta { min-width: 0; }
    .title { font-size: 1.1rem; font-weight: 800; margin-bottom: .25rem; color: #eafff8; }
    .sub   { color: #bfeee2; font-size: .95rem; }
    .controls { display: flex; gap: .5rem; align-items: center; margin-top: .75rem; }
    .big { font-size: 1rem; padding: .9rem 1.1rem; }
    .ghost { background: transparent; border: 1px solid rgba(255,255,255,.25); color: #d7fff4; box-shadow: none; }
    .drop {
      border: 2px dashed rgba(255,255,255,.25); border-radius: 14px; padding: .9rem; text-align: center;
      color: #c7f7ed; background: rgba(0,0,0,.15);
    }
    .badge { font-size:.8rem; background: var(--mint-700); color:#073e32; border-radius:999px; padding:.2rem .5rem; }
    a { color: var(--mint-500); text-decoration: none; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <h1>Mint Music Player</h1>
      </div>
      <div class="auth" id="authArea">
        <span class="pill">Checking sign-in…</span>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <label for="musicUrl">Paste an Amazon Music URL or a direct audio link</label>
        <input id="musicUrl" type="url" placeholder="https://music.amazon.com/..." autocomplete="off"/>
        <div class="row">
          <button id="playBtn" class="big">Play</button>
          <button id="openBtn" class="secondary big">Open in Amazon Music</button>
          <button id="copyBtn" class="ghost">Copy URL</button>
        </div>
        <div id="msg" class="hint"></div>
        <div class="hint">Tip: Drop an MP3/M4A file below to play it directly in the mint player.</div>
        <div id="drop" class="drop" style="margin-top:.9rem;">Drop audio file here (mp3, m4a, aac)</div>
      </div>

      <div class="card">
        <div class="player">
          <div id="cover" class="cover" aria-label="Album art"></div>
          <div class="meta">
            <div id="title" class="title">Nothing playing</div>
            <div id="sub" class="sub">Paste a link to get started</div>
            <div class="controls">
              <button id="toggleBtn">▶︎</button>
              <button id="stopBtn" class="secondary">Stop</button>
              <span id="status" class="pill">Idle</span>
            </div>
          </div>
        </div>
        <audio id="audio" crossorigin="anonymous"></audio>
      </div>
    </div>

    <div class="hint" style="margin-top:1rem;">
      <span class="badge">Heads up</span>
      Playback for Amazon Music links happens in Amazon’s official player. This app previews art/details and gives you a clean launcher.
    </div>
  </div>

<script>
  const el = (id) => document.getElementById(id);
  const authArea = el('authArea');
  const msg = el('msg');
  const urlInput = el('musicUrl');
  const playBtn = el('playBtn');
  const openBtn = el('openBtn');
  const copyBtn = el('copyBtn');
  const drop = el('drop');

  const cover = el('cover');
  const titleEl = el('title');
  const subEl = el('sub');
  const statusEl = el('status');
  const audio = el('audio');
  const toggleBtn = el('toggleBtn');
  const stopBtn = el('stopBtn');

  const AMAZON_HOSTS = [
    'music.amazon.com','music.amazon.co.uk','music.amazon.de','music.amazon.co.jp','music.amazon.in',
    'music.amazon.ca','music.amazon.com.au','music.amazon.fr','music.amazon.it','music.amazon.es',
    'music.amazon.com.mx','music.amazon.com.br'
  ];

  function setMsg(text, kind='') {
    msg.textContent = text || '';
    msg.className = 'hint' + (kind ? ' ' + kind : '');
  }

  function isAmazonMusicUrl(u) {
    try {
      const url = new URL(u);
      return AMAZON_HOSTS.includes(url.hostname.toLowerCase());
    } catch { return false; }
  }

  function isDirectAudio(u) {
    return /\.(mp3|m4a|aac|ogg|wav)(\?.*)?$/i.test(u || '');
  }

  function ensureHttps(u) {
    try { const url = new URL(u); url.protocol = 'https:'; return url.toString(); } catch { return u; }
  }

  async function fetchMe() {
    const r = await fetch('/me', { credentials: 'include' });
    if (!r.ok) return { loggedIn:false };
    return r.json();
  }

  async function renderAuth() {
    const me = await fetchMe();
    if (me.loggedIn) {
      authArea.innerHTML = \`
        <span class="pill">Signed in as <strong>\${me.name || 'Amazon user'}</strong></span>
        <button id="logoutBtn" class="secondary">Sign out</button>
      \`;
      document.getElementById('logoutBtn').onclick = async () => {
        await fetch('/logout', { method: 'POST', credentials: 'include' });
        location.reload();
      };
    } else {
      authArea.innerHTML = '<a href="/login"><button>Sign in with Amazon</button></a>';
    }
  }

  async function loadMetadata(u) {
    if (!isAmazonMusicUrl(u)) return;
    try {
      const r = await fetch('/metadata?url=' + encodeURIComponent(u));
      const data = await r.json();
      if (data.ok && data.meta) {
        if (data.meta.image) cover.style.backgroundImage = 'url(' + data.meta.image + ')';
        titleEl.textContent = data.meta.title || 'Amazon Music';
        subEl.textContent = data.meta.site ? data.meta.site : 'Amazon Music';
      }
    } catch {}
  }

  function resetPlayerUI() {
    cover.style.backgroundImage = '';
    titleEl.textContent = 'Nothing playing';
    subEl.textContent = 'Paste a link to get started';
    statusEl.textContent = 'Idle';
    toggleBtn.textContent = '▶︎';
  }

  function playDirect(u, displayTitle='Direct audio') {
    audio.src = u;
    audio.play().then(() => {
      statusEl.textContent = 'Playing';
      toggleBtn.textContent = '⏸';
      titleEl.textContent = displayTitle;
      subEl.textContent = 'Direct stream';
      if (!cover.style.backgroundImage) {
        cover.style.backgroundImage = 'linear-gradient(135deg, #0fb88f, #25dbb1)';
      }
    }).catch(() => {
      statusEl.textContent = 'Error';
      setMsg('Could not start playback. Some URLs block cross-origin streaming.', 'err');
    });
  }

  playBtn.onclick = async () => {
    setMsg('');
    const raw = urlInput.value.trim();
    if (!raw) return setMsg('Enter a URL first.', 'err');
    const u = ensureHttps(raw);
    const me = await fetchMe();
    if (!me.loggedIn) return setMsg('Please sign in with Amazon first.', 'err');

    if (isDirectAudio(u)) {
      playDirect(u, 'Direct audio');
      return;
    }

    if (isAmazonMusicUrl(u)) {
      // Show metadata and hand off to official player for playback
      await loadMetadata(u);
      setMsg('Amazon Music playback opens in their official player.', 'ok');
      window.open(u, '_blank', 'noopener');
      return;
    }

    setMsg('Unsupported URL. Use Amazon Music links or direct audio files.', 'err');
  };

  openBtn.onclick = async () => {
    const raw = urlInput.value.trim();
    if (!raw) return setMsg('Enter a URL to open.', 'err');
    const u = ensureHttps(raw);
    if (!isAmazonMusicUrl(u)) return setMsg('Not an Amazon Music URL.', 'err');
    window.open(u, '_blank', 'noopener');
    setMsg('Opening in a new tab…', 'ok');
    await loadMetadata(u);
  };

  copyBtn.onclick = async () => {
    const raw = urlInput.value.trim();
    if (!raw) return setMsg('Enter a URL to copy.', 'err');
    const u = ensureHttps(raw);
    await navigator.clipboard.writeText(u);
    setMsg('Copied URL to clipboard.', 'ok');
  };

  toggleBtn.onclick = async () => {
    if (!audio.src) return;
    if (audio.paused) {
      await audio.play().catch(() => setMsg('Could not resume playback.', 'err'));
      toggleBtn.textContent = '⏸';
      statusEl.textContent = 'Playing';
    } else {
      audio.pause();
      toggleBtn.textContent = '▶︎';
      statusEl.textContent = 'Paused';
    }
  };

  stopBtn.onclick = () => {
    audio.pause();
    audio.currentTime = 0;
    resetPlayerUI();
  };

  // Drag & drop local file playback
  ;['dragenter','dragover'].forEach(evt => drop.addEventListener(evt, (e) => {
    e.preventDefault(); e.stopPropagation();
    drop.style.background = 'rgba(15, 184, 143, .18)';
  }));
  ;['dragleave','drop'].forEach(evt => drop.addEventListener(evt, (e) => {
    e.preventDefault(); e.stopPropagation();
    drop.style.background = 'rgba(0,0,0,.15)';
  }));
  drop.addEventListener('drop', (e) => {
    const f = e.dataTransfer.files[0];
    if (!f) return;
    if (!/audio\/(mpeg|mp4|aac|wav|ogg)/.test(f.type)) {
      return setMsg('Unsupported file. Use mp3, m4a, aac, wav, or ogg.', 'err');
    }
    const url = URL.createObjectURL(f);
    cover.style.backgroundImage = 'linear-gradient(135deg, #0fb88f, #25dbb1)';
    playDirect(url, f.name);
  });

  // Init
  resetPlayerUI();
  renderAuth();
</script>
</body>
</html>
